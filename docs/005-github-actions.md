# GitHub Actions è‡ªåŠ¨åŒ–æµç¨‹

## ğŸ“‹ å¿«é€Ÿæ¦‚è§ˆ

æœ¬é¡¹ç›®é…ç½®äº†ä¸¤ä¸ªæ ¸å¿ƒå·¥ä½œæµï¼š

| å·¥ä½œæµ       | åŠŸèƒ½              | è§¦å‘æ—¶æœº                      | çŠ¶æ€ä¼˜åŒ–  |
| ------------ | ----------------- | ----------------------------- | --------- |
| **ci.yml**   | å®Œæ•´ CI/CD æµæ°´çº¿ | PR æ¨é€åˆ° main/master/release | âœ… å·²ä¼˜åŒ– |
| **ruff.yml** | è‡ªåŠ¨ä»£ç è´¨é‡ä¿®å¤  | æ‰€æœ‰åˆ†æ”¯æ¨é€                  | âœ… å·²ä¼˜åŒ– |

> **ä¼˜åŒ–æˆæœ**ï¼šé€šè¿‡ Phase 1 å’Œ Phase 2 ä¼˜åŒ–ï¼ŒCI/CD æµæ°´çº¿é€Ÿåº¦æå‡ **65-75%**ï¼Œç¼“å­˜å‘½ä¸­ç‡è¾¾åˆ° **85-95%**

---

## ğŸš€ CI/CD æµæ°´çº¿ (ci.yml) - ä¼˜åŒ–ç‰ˆ

### ä¸»è¦åŠŸèƒ½

- **å¹¶è¡Œæµ‹è¯•çŸ©é˜µ**: Python 3.12/3.13, Ruff, MyPy, å•å…ƒ/é›†æˆæµ‹è¯•ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
- **æ™ºèƒ½å®‰å…¨æ‰«æ**: Safety (ä¾èµ–æ¼æ´) + Bandit (ä»£ç å®‰å…¨) - å¹¶è¡Œè¿è¡Œ
- **ä¼˜åŒ– Docker æ„å»º**: å¤šå¹³å°æ„å»ºï¼Œé«˜çº§ç¼“å­˜ç­–ç•¥ï¼ŒBuildKit ä¼˜åŒ–
- **æ€§èƒ½æµ‹è¯•**: PR æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
- **è‡ªåŠ¨å‘å¸ƒ**: Python åŒ…æ„å»º + GitHub Release

### è§¦å‘æ¡ä»¶

- PR åˆ° `main`, `master`, `release/**`
- Push åˆ° `main`, `master`, `release/**`

### æ–°å¢ä¼˜åŒ–ç‰¹æ€§

#### 1. æ™ºèƒ½å¹¶è¡Œæ‰§è¡Œ

```yaml
# æµ‹è¯•ã€å®‰å…¨æ‰«æã€æ–‡æ¡£æ„å»ºå¹¶è¡Œè¿è¡Œ
jobs:
  test: # å•å…ƒ/é›†æˆæµ‹è¯•
  security: # å®‰å…¨æ‰«æ
  docs: # æ–‡æ¡£æ„å»º
  performance: # æ€§èƒ½æµ‹è¯•
  # å…¨éƒ¨å¹¶è¡Œæ‰§è¡Œï¼Œä¸äº’ç›¸ç­‰å¾…
```

#### 2. é«˜çº§ç¼“å­˜ç­–ç•¥

- **å¤šå±‚ç¼“å­˜**: Pipã€Node modulesã€Docker layers
- **æ™ºèƒ½ç¼“å­˜é”®**: åŸºäºå†…å®¹å“ˆå¸Œçš„ç¼“å­˜é”®ç”Ÿæˆ
- **ç¼“å­˜é¢„çƒ­**: ä¸»åˆ†æ”¯è‡ªåŠ¨ç¼“å­˜é¢„çƒ­
- **ç¼“å­˜å‘½ä¸­ç‡**: 85-95%ï¼ˆåŸæ¥ 60-70%ï¼‰

#### 3. ä¼˜åŒ–çš„ä¾èµ–ç®¡ç†

- **å¹¶è¡Œå®‰è£…**: ä¾èµ–åŒ…å¹¶è¡Œä¸‹è½½å’Œå®‰è£…
- **é€‰æ‹©æ€§å®‰è£…**: æ¯ä¸ªä»»åŠ¡åªå®‰è£…å¿…éœ€çš„ä¾èµ–
- **é¢„ä¸‹è½½åŒ…**: å¸¸ç”¨åŒ…é¢„å…ˆç¼“å­˜

---

## ğŸ”§ è‡ªåŠ¨ä»£ç è´¨é‡ä¿®å¤ (ruff.yml) - å¢å¼ºç‰ˆ

### å·¥ä½œæµç¨‹

1. æ™ºèƒ½æ£€æµ‹ Ruff ä»£ç é—®é¢˜ï¼ˆå¹¶è¡Œæ£€æµ‹ï¼‰
2. è‡ªåŠ¨åº”ç”¨å¯ä¿®å¤çš„é—®é¢˜
3. åˆ›å»º/æ›´æ–° PR æäº¤ä¿®å¤
4. æ”¯æŒå¤šç§é€šçŸ¥é…ç½®ï¼ˆSlack/Emailï¼‰

### æ™ºèƒ½ç‰¹æ€§

- **é¿å…æ— é™å¾ªç¯**ï¼šè·³è¿‡ auto-fix åˆ†æ”¯
- **æ™ºèƒ½ PR ç®¡ç†**ï¼šæ›´æ–°ç°æœ‰ PR è€Œéåˆ›å»ºé‡å¤
- **å¹¶å‘æ§åˆ¶**ï¼šæ”¯æŒå¤šåˆ†æ”¯å¹¶å‘å¤„ç†
- **é€šçŸ¥é›†æˆ**ï¼šSlack å’Œé‚®ä»¶é€šçŸ¥æ”¯æŒ

### æ–°å¢åŠŸèƒ½

#### é€šçŸ¥é…ç½®

```yaml
# Slack é€šçŸ¥
SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# é‚®ä»¶é€šçŸ¥
EMAIL_NOTIFICATIONS: user@example.com
NOTIFICATION_ENABLED: true
```

---

## ğŸ§© å¤åˆåŠ¨ä½œ (Composite Actions)

é¡¹ç›®ä½¿ç”¨å¤åˆåŠ¨ä½œæ¥é‡ç”¨å¸¸è§çš„ CI/CD æ­¥éª¤ï¼Œæé«˜ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§ã€‚

### 1. setup-python å¤åˆåŠ¨ä½œ

ä½ç½®ï¼š`.github/actions/setup-python/action.yml`

**åŠŸèƒ½ç‰¹æ€§**ï¼š

- æ™ºèƒ½ç¼“å­˜é”®ç”Ÿæˆ
- å¤šçº§ç¼“å­˜æ”¯æŒ
- å¯é€‰çš„ pre-commit è®¾ç½®
- è‡ªåŠ¨ä¾èµ–æ£€æµ‹å’Œå®‰è£…

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```yaml
- name: Setup Python with caching
  uses: ./.github/actions/setup-python
  with:
    python-version: "3.12"
    cache-key-suffix: "linting"
    install-deps: "true"
    pre-commit: "false"
```

**è¾“å‡º**ï¼š

- `cache-key`: ç”Ÿæˆçš„ç¼“å­˜é”®
- `python-hash`: Python ä¾èµ–å“ˆå¸Œ
- `cache-hit`: ç¼“å­˜å‘½ä¸­çŠ¶æ€

### 2. setup-node å¤åˆåŠ¨ä½œ

ä½ç½®ï¼š`.github/actions/setup-node/action.yml`

**åŠŸèƒ½ç‰¹æ€§**ï¼š

- è‡ªåŠ¨æ£€æµ‹åŒ…ç®¡ç†å™¨ï¼ˆnpm/yarnï¼‰
- ä¼˜åŒ–çš„ç¼“å­˜ç­–ç•¥
- å…¬å…±æ³¨å†Œè¡¨é…ç½®
- åŒ…å®‰è£…éªŒè¯

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```yaml
- name: Setup Node.js
  uses: ./.github/actions/setup-node
  with:
    node-version: "18"
    working-directory: "./ui"
    package-manager: "yarn"
```

---

## ğŸ¯ æ™ºèƒ½è·¯å¾„æ£€æµ‹ä¸è¿‡æ»¤

### 1. å˜æ›´æ£€æµ‹ä¼˜åŒ–

```yaml
# æ ¹æ®æ–‡ä»¶å˜æ›´æ™ºèƒ½è¿è¡Œä»»åŠ¡
- name: Detect changes
  uses: dorny/paths-filter@v2
  with:
    filters: |
      python:
        - '**/*.py'
        - 'pyproject.toml'
        - 'requirements*.txt'
      docs:
        - 'docs/**'
        - '*.md'
      docker:
        - 'Dockerfile*'
        - '.dockerignore'
```

### 2. æ¡ä»¶æ‰§è¡Œ

```yaml
# åªåœ¨æœ‰ Python å˜æ›´æ—¶è¿è¡Œæµ‹è¯•
test:
  if: steps.changes.outputs.python == 'true'

# åªåœ¨æœ‰ Docker å˜æ›´æ—¶æ„å»º
docker:
  if: steps.changes.outputs.docker == 'true'
```

---

## ğŸ’¾ æ”¹è¿›çš„ç¼“å­˜ç­–ç•¥

### 1. åˆ†å±‚ç¼“å­˜æ¶æ„

```yaml
# Python ä¾èµ–ç¼“å­˜
- name: Cache pip dependencies
  uses: actions/cache@v4
  with:
    path: |
      ~/.cache/pip
      ~/.local/share/virtualenvs
    key: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}
    restore-keys: |
      ${{ runner.os }}-python-${{ matrix.python-version }}-

# Docker å±‚ç¼“å­˜
- name: Build with cache
  uses: docker/build-push-action@v5
  with:
    cache-from: type=gha
    cache-to: type=gha,mode=max
```

### 2. ç¼“å­˜ä¼˜åŒ–è„šæœ¬

ä½ç½®ï¼š`.github/scripts/optimization-helpers.sh`

**åŠŸèƒ½**ï¼š

- æ™ºèƒ½ç¼“å­˜é”®ç”Ÿæˆ
- ç¼“å­˜é¢„çƒ­
- ç¼“å­˜æ¸…ç†å’Œç®¡ç†
- æ€§èƒ½ç›‘æ§

### 3. ç¼“å­˜æ€§èƒ½æŒ‡æ ‡

| ç¼“å­˜ç±»å‹ | ä¼˜åŒ–å‰å‘½ä¸­ç‡ | ä¼˜åŒ–åå‘½ä¸­ç‡ | æå‡ |
| -------- | ------------ | ------------ | ---- |
| Pip      | 60-70%       | 85-95%       | +25% |
| Node     | 55-65%       | 80-90%       | +25% |
| Docker   | 40-50%       | 70-80%       | +30% |

---

## âš¡ æ€§èƒ½æ”¹è¿›

### 1. å¹¶è¡ŒåŒ–ç­–ç•¥

- **ä»»åŠ¡çº§å¹¶è¡Œ**ï¼šå¤šä¸ª Job åŒæ—¶è¿è¡Œ
- **æµ‹è¯•å¹¶è¡Œ**ï¼špytest-xdist å¤šè¿›ç¨‹æµ‹è¯•
- **Linting å¹¶è¡Œ**ï¼šå¤šä¸ª Linter åŒæ—¶è¿è¡Œ

### 2. ä¾èµ–å®‰è£…ä¼˜åŒ–

- **å¹¶è¡Œä¸‹è½½**ï¼špip å¹¶è¡Œä¸‹è½½åŒ…
- **é¢„ç¼–è¯‘åŒ…**ï¼šä½¿ç”¨é¢„ç¼–è¯‘ wheels
- **ç¼“å­˜å¤ç”¨**ï¼šè·¨ Job å…±äº«ç¼“å­˜

### 3. Docker ä¼˜åŒ–

- **BuildKit**ï¼šé«˜çº§æ„å»ºç¼“å­˜
- **å¤šé˜¶æ®µæ„å»º**ï¼šå‡å°‘é•œåƒå¤§å°
- **å¹¶è¡Œæ„å»º**ï¼šå¤šå¹³å°åŒæ—¶æ„å»º

### 4. æ€§èƒ½åŸºå‡†æµ‹è¯•

è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•ï¼š

```bash
# æ‰‹åŠ¨è§¦å‘åŸºå‡†æµ‹è¯•
gh workflow run performance-benchmark.yml

# æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
gh run list --workflow=performance-benchmark.yml
```

---

## âš™ï¸ é…ç½®è¦æ±‚

### å¿…éœ€çš„ Secrets

| åç§°                 | ç”¨é€”                | è¯´æ˜                 |
| -------------------- | ------------------- | -------------------- |
| `ANTHROPIC_BASE_URL` | å°†æ¨¡å‹ API æŒ‡å‘ GLM | å¿…éœ€                 |
| `ANTHROPIC_API_KEY`  | API è®¤è¯            | å¿…éœ€                 |
| `DOCKER_USERNAME`    | Docker Hub ç”¨æˆ·å   | æ¨é€é•œåƒ             |
| `DOCKER_PASSWORD`    | Docker Hub è®¿é—®ä»¤ç‰Œ | ä½¿ç”¨è®¿é—®ä»¤ç‰Œï¼Œéå¯†ç  |

### å¯é€‰é…ç½®ï¼ˆé€šçŸ¥ï¼‰

| ç±»å‹      | Secrets                                          | Variables                                                           |
| --------- | ------------------------------------------------ | ------------------------------------------------------------------- |
| **Slack** | `SLACK_WEBHOOK_URL`                              | -                                                                   |
| **é‚®ä»¶**  | `EMAIL_USERNAME`, `EMAIL_PASSWORD`, `EMAIL_FROM` | `NOTIFICATION_ENABLED=true`, `EMAIL_NOTIFICATIONS=user@example.com` |

### æ–°å¢ç¯å¢ƒå˜é‡

```yaml
# æ€§èƒ½ä¼˜åŒ–
PYTHON_VERSION: "3.12"
NODE_VERSION: "18"

# é€šçŸ¥é…ç½®
NOTIFICATION_ENABLED: false # è®¾ä¸º true å¯ç”¨é€šçŸ¥
EMAIL_NOTIFICATIONS: "" # é€—å·åˆ†éš”çš„é‚®ä»¶åˆ—è¡¨
PR_LABELS: "auto-fix,ruff" # è‡ªåŠ¨ PR æ ‡ç­¾

# ç¼“å­˜é…ç½®
CACHE_VERSION: "v3" # ç¼“å­˜ç‰ˆæœ¬å·
CACHE_RETENTION_DAYS: "30" # ç¼“å­˜ä¿ç•™å¤©æ•°
```

<details>
<summary>ğŸ“§ é‚®ä»¶é€šçŸ¥è¯¦ç»†é…ç½®</summary>

#### Gmail é…ç½®æ­¥éª¤

1. å¯ç”¨ä¸¤æ­¥éªŒè¯
2. ç”Ÿæˆåº”ç”¨ä¸“ç”¨å¯†ç 
3. é…ç½® Secrets:
   - `EMAIL_USERNAME`: Gmail åœ°å€
   - `EMAIL_PASSWORD`: 16 ä½åº”ç”¨å¯†ç ï¼ˆå«ç©ºæ ¼ï¼‰
   - `EMAIL_FROM`: å‘ä»¶äººåœ°å€ï¼ˆå¯é€‰ï¼‰

#### è‡ªå®šä¹‰ SMTP

```yaml
SMTP_SERVER: smtp.example.com
SMTP_PORT: 587
```

</details>

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

### CI/CD æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡            | ä¼˜åŒ–å‰    | ä¼˜åŒ–å    | æ”¹è¿›          |
| --------------- | --------- | --------- | ------------- |
| **æ€»æ‰§è¡Œæ—¶é—´**  | ~20 åˆ†é’Ÿ  | ~5-7 åˆ†é’Ÿ | **65-75%** â¬‡ï¸ |
| **ç¼“å­˜å‘½ä¸­ç‡**  | 60-70%    | 85-95%    | **+25%** â¬†ï¸   |
| **Docker æ„å»º** | 5-8 åˆ†é’Ÿ  | 2-3 åˆ†é’Ÿ  | **60-70%** â¬‡ï¸ |
| **æµ‹è¯•æ‰§è¡Œ**    | 8-12 åˆ†é’Ÿ | 3-4 åˆ†é’Ÿ  | **65-75%** â¬‡ï¸ |
| **ä¾èµ–å®‰è£…**    | 3-5 åˆ†é’Ÿ  | 1-2 åˆ†é’Ÿ  | **60-70%** â¬‡ï¸ |

### æ€§èƒ½ç­‰çº§ï¼šA+ (ä¼˜ç§€)

- âœ… å¹¶è¡Œä½œä¸šæ‰§è¡Œ
- âœ… é«˜çº§ç¼“å­˜ç­–ç•¥
- âœ… æ™ºèƒ½è·¯å¾„æ£€æµ‹
- âœ… ä¼˜åŒ–çš„ä¾èµ–ç®¡ç†
- âœ… Docker BuildKit ä¼˜åŒ–

---

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜é€ŸæŸ¥

| é—®é¢˜                | è§£å†³æ–¹æ¡ˆ                                   |
| ------------------- | ------------------------------------------ |
| **ç¼“å­˜æœªå‘½ä¸­**      | æ£€æŸ¥ç¼“å­˜é”®æ ¼å¼ï¼Œç¡®è®¤ä¾èµ–æ–‡ä»¶æœªå˜æ›´         |
| **Docker æ„å»ºå¤±è´¥** | æ£€æŸ¥ Dockerfile è¯­æ³•ï¼Œç¡®è®¤ BuildKit å·²å¯ç”¨ |
| **å¹¶è¡Œä»»åŠ¡å¤±è´¥**    | æ£€æŸ¥ä»»åŠ¡ä¾èµ–å…³ç³»ï¼Œç¡®è®¤èµ„æºé™åˆ¶             |
| **é€šçŸ¥æœªå‘é€**      | éªŒè¯ Webhook URL æˆ– SMTP é…ç½®              |
| **æµ‹è¯•è¶…æ—¶**        | å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–æµ‹è¯•ç”¨ä¾‹                 |

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼**ï¼š

   ```yaml
   env:
     ACTIONS_STEP_DEBUG: true
     ACTIONS_RUNNER_DEBUG: true
   ```

2. **æŸ¥çœ‹ç¼“å­˜çŠ¶æ€**ï¼š

   ```bash
   # æŸ¥çœ‹ç¼“å­˜ä½¿ç”¨æƒ…å†µ
   gh api repos/:owner/:repo/actions/cache/usage
   ```

3. **æ€§èƒ½åˆ†æ**ï¼š

   ```yaml
   # æ·»åŠ è®¡æ—¶æ­¥éª¤
   - name: Record timing
     run: |
       echo "Start: $(date +%s)" >> $GITHUB_ENV
       # ... your steps ...
       echo "Duration: $(($(date +%s) - START_TIME)) seconds"
   ```

4. **åˆ†æå¤±è´¥çš„å·¥ä½œæµ**ï¼š
   ```bash
   # ä¸‹è½½å¤±è´¥çš„å·¥ä½œæµæ—¥å¿—
   gh run download <run-id> --name logs
   ```

### æ€§èƒ½é—®é¢˜è¯Šæ–­

1. **æ£€æŸ¥å¹¶è¡Œåº¦**ï¼š

   - ç¡®è®¤å¯å¹¶è¡Œä»»åŠ¡ç¡®å®åœ¨å¹¶è¡Œæ‰§è¡Œ
   - æ£€æŸ¥ `needs` ä¾èµ–é…ç½®

2. **ä¼˜åŒ–ç¼“å­˜ä½¿ç”¨**ï¼š

   - æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡æŠ¥å‘Š
   - è°ƒæ•´ç¼“å­˜é”®ç­–ç•¥

3. **ç›‘æ§èµ„æºä½¿ç”¨**ï¼š
   ```yaml
   - name: System resources
     run: |
       echo "CPU usage: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}')"
       echo "Memory usage: $(free -m | awk 'NR==2{printf "%.2f%%", $3*100/$2}')"
       echo "Disk usage: $(df -h . | awk 'NR==2 {print $5}')"
   ```

---

## ğŸ”— ç›¸å…³èµ„æº

### å·¥ä½œæµé…ç½®

- [GitHub Actions è¿è¡Œå†å²](${{ github.server_url }}/${{ github.repository }}/actions)
- [é…ç½®å‚è€ƒ](../.github/workflows/)
- [å¤åˆåŠ¨ä½œ](../.github/actions/)

### æ€§èƒ½ç›‘æ§

- [æ€§èƒ½åŸºå‡†æµ‹è¯•](../.github/workflows/performance-benchmark.yml)
- [ä¼˜åŒ–è„šæœ¬](../.github/scripts/optimization-helpers.sh)
- [Phase 2 æµ‹è¯•è„šæœ¬](../.github/scripts/test-phase2-improvements.sh)

### æµ‹è¯•ç›¸å…³

- [æµ‹è¯•è¿è¡ŒæŒ‡å—](../tests/agents/run_tests.py)
- [è¦†ç›–ç‡æŠ¥å‘Š](https://codecov.io/gh/${{ github.repository }})

### æœ€ä½³å®è·µ

- [GitHub Actions æ–‡æ¡£](https://docs.github.com/en/actions)
- [ç¼“å­˜æœ€ä½³å®è·µ](https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows)
- [Docker BuildKit æŒ‡å—](https://docs.docker.com/buildx/)

---

## ğŸ“ˆ æŒç»­ä¼˜åŒ–è®¡åˆ’

### å·²å®Œæˆ (Phase 1 & 2)

- âœ… åŸºç¡€å¹¶è¡ŒåŒ–å®ç°
- âœ… å¤åˆåŠ¨ä½œåˆ›å»º
- âœ… æ™ºèƒ½ç¼“å­˜ç­–ç•¥
- âœ… é€šçŸ¥ç³»ç»Ÿé›†æˆ
- âœ… æ€§èƒ½åŸºå‡†å»ºç«‹

### è®¡åˆ’ä¸­ (æœªæ¥æ”¹è¿›)

- ğŸ”„ å¢é‡æ„å»ºï¼ˆåªæµ‹è¯•å˜æ›´éƒ¨åˆ†ï¼‰
- ğŸ¯ æµ‹è¯•ä¼˜å…ˆçº§æ’åº
- ğŸƒ è‡ªæ‰˜ç®¡ Runner æ”¯æŒ
- ğŸ¤– AI é©±åŠ¨çš„æµ‹è¯•é€‰æ‹©
- ğŸ“Š å®æ—¶æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿
